<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>OTC</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta http-equiv="cache-control" content="no-cache">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link href="css/mui.min.css" rel="stylesheet" />
    <link href="css/base.css" rel="stylesheet" />

    <!-- http://dev.dcloud.net.cn/mui/pulldown/ -->
    <style type="text/css">
        html,
        body {
            background-color: #efeff4;
        }

        .mui-bar~.mui-content .mui-fullscreen {
            top: 44px;
            height: auto;
        }

        .mui-pull-top-tips {
            position: absolute;
            top: -20px;
            left: 50%;
            margin-left: -25px;
            width: 40px;
            height: 40px;
            border-radius: 100%;
            z-index: 1;
        }

        .mui-bar~.mui-pull-top-tips {
            top: 24px;
        }

        .mui-pull-top-wrapper {
            width: 42px;
            height: 42px;
            display: block;
            text-align: center;
            background-color: #efeff4;
            border: 1px solid #ddd;
            border-radius: 25px;
            background-clip: padding-box;
            box-shadow: 0 4px 10px #bbb;
            overflow: hidden;
        }

        .mui-pull-top-tips.mui-transitioning {
            -webkit-transition-duration: 200ms;
            transition-duration: 200ms;
        }

        .mui-pull-top-tips .mui-pull-loading {
            /*-webkit-backface-visibility: hidden;
        -webkit-transition-duration: 400ms;
        transition-duration: 400ms;*/
            margin: 0;
        }

        .mui-pull-top-wrapper .mui-icon,
        .mui-pull-top-wrapper .mui-spinner {
            margin-top: 7px;
        }

        .mui-pull-top-wrapper .mui-icon.mui-reverse {
            /*-webkit-transform: rotate(180deg) translateZ(0);*/
        }

        .mui-pull-bottom-tips {
            text-align: center;
            background-color: #efeff4;
            font-size: 15px;
            line-height: 40px;
            color: #777;
        }

        .mui-pull-top-canvas {
            overflow: hidden;
            background-color: #fafafa;
            border-radius: 40px;
            box-shadow: 0 4px 10px #bbb;
            width: 40px;
            height: 40px;
            margin: 0 auto;
        }

        .mui-pull-top-canvas canvas {
            width: 40px;
        }

        .mui-slider-indicator.mui-segmented-control {
            background-color: #efeff4;
        }

        .mui-fullscreen {
            bottom: 55px;
        }
        /*------------------购买-------------------*/

        h4 {
            margin-right: 20px;
        }

        .list_btn {
            margin: 10px 0;
            right: 10px;
        }

        .jy_type {
            text-align: center;
            margin: auto;
            padding: 5px 10px;
            color: #FFFFFF;
            background-color: green;
            width: 30%;
        }
        /*------------------发布------------------*/

        .fb_text {
            color: #FFFFFF;
            background-color: #FF0000;
            padding: 20px;
        }

        .fb_title {
            margin: 10px;
        }

        .mui-input-range input[type=range] {
            margin-left: 20px;
            width: 70%;
        }

        #field-range-input {
            width: 17%;
            float: right;
            margin-right: 10px;
        }

        .mui-btn-block {
            width: 90%;
            margin: 20px auto;
        }

        .yzm_btn {
            width: 25%;
            float: right;
            border-radius: 0;
            margin-right: 1%;
            margin-top: 3px;
            border: none;
            color: #FFFFFF;
            background-color: #CCCCCC;
        }
        /*------------------我的------------------*/

        .user_info {
            color: #FFFFFF;
            background-color: #007AFF;
            padding: 30px;
            text-align: center;
        }
        /*.user_info span {*/
        /*font-size: 70px;*/
        /*}*/

        .user-avatar {
            font-size: 70px;
        }

        .user_text {
            margin: 5px auto;
            padding: 0 10px;
        }

        .server {
            margin-bottom: 20px;
        }

        .inmoney {

        }

        .platform {

        }
    </style>
</head>

<body>
<header class="mui-bar mui-bar-nav mui-bar-transparent">
    <h1 class="mui-title" id="IndexNavTitle">购买列表</h1>
</header>
<nav class="mui-bar mui-bar-tab">
    <a id="Tab1" class="mui-tab-item mui-active" href="#item1mobile"> <!--onclick="changeTab('item1mobile')"-->
        <span class="mui-icon mui-icon-undo"></span>
        <span class="mui-tab-label">购买</span>
    </a>
    <a id="Tab2" class="mui-tab-item" href="#item2mobile" >
        <span class="mui-icon mui-icon-redo"></span>
        <span class="mui-tab-label">出售</span>
    </a>
    <a id="Tab3" class="mui-tab-item" href="#item3mobile"> <!--onclick="changeTab('item3mobile')"-->
        <!--href="#item3mobile"-->
        <span class="mui-icon mui-icon-paperplane"></span>
        <span class="mui-tab-label">发布</span>
    </a>
    <a id="Tab4" class="mui-tab-item" href="#item4mobile"> <!--onclick="changeTab('item4mobile')"-->
        <!--href="#item4mobile"-->
        <span class="mui-icon mui-icon-contact"></span>
        <span class="mui-tab-label">我的</span>
    </a>
</nav>
<div class="mui-content">

    <div id="slider" class="mui-slider mui-fullscreen">

        <div class="mui-slider-group">
            <!-- 购买单列表 -->
            <div id="item1mobile" class="mui-slider-item mui-control-content mui-active">
                <div id="buy-scroll" class="mui-scroll-wrapper">
                    <div class="mui-scroll" id="tfbuy-scroll">
                        <ul class="mui-table-view" id="tf-sell"></ul>
                    </div>
                </div>
            </div>
            <!-- 出售单列表 -->
            <div id="item2mobile" class="mui-slider-item mui-control-content">
                <div class="mui-scroll-wrapper">
                    <div class="mui-scroll" id="tfsell-scroll">
                        <ul class="mui-table-view" id="tf-buy"></ul>
                    </div>
                </div>
            </div>
            <!-- 发布 -->
            <div id="item3mobile" class="mui-slider-item mui-control-content " style="overflow-y:auto;">
                <div class="mui-col-sm-12">
                    <div class="fb_text">
                        发布一则交易挂单是免费的，每笔完成的交易需要缴纳3‰的费用 <!--，钱包中至少有50000TF，挂单才会显示。-->
                    </div>
                    <div class="fb_title">
                        选择挂单类型：
                    </div>
                    <div class="mui-card">
                        <form class="mui-input-group ">
                            <div class="mui-input-row mui-radio">
                                <label>在线出售USDT</label>
                                <input name="tradeType" value="sell" type="radio" checked onchange="changePreOrderType(this)" />
                            </div>
                            <!--<div class="mui-input-row mui-radio">
                                <label>在线购买TF</label>
                                <input name="tradeType" value="buy" type="radio" onchange="changePreOrderType(this)" />
                            </div>-->
                        </form>
                    </div>
                    <div class="mui-card">
                        <div class="mui-card-content">
                            <div class="mui-card-content-inner">
                                <p>市场参考单价：<span id="CoinPrice"></span> CNY</p>
                            </div>
                            <form class="mui-input-group" id="PreTradeForm">
                                <div class="mui-input-row">
                                    <label>出售量：</label>
                                    <input type="number" placeholder="请输入出售量" id="AmountIpt" />
                                </div>

                                <div class="mui-input-row">
                                    <label>收款人姓名：</label>
                                    <input type="text" placeholder="请输入真实姓名" id="ToRealName" />
                                </div>
                                <div class="mui-input-row input-buy-max" >
                                    <label>银行卡号：</label>
                                    <input type="number" placeholder="请输入银行卡号" id="ToPayAccount" />
                                </div>
                                <div class="mui-input-row" >
                                    <label>银行：</label>
                                    <input type="text" placeholder="请输入银行" id="ToBank" />
                                </div>
                                <div class="mui-input-row" >
                                    <label>支行：</label>
                                    <input type="text" placeholder="请输入支行" id="ToBranchBank" />
                                </div>

                                <div class="mui-input-row" style="margin: 10px 5px;">
                                    <textarea id="MsgIpt" rows="1" placeholder="选填挂单留言"></textarea>
                                </div>
                                <button type="button" class="mui-btn mui-btn-primary mui-btn-block" onclick="publishPretrade()">立即发布</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <!--我的-->
            <div id="item4mobile" class="mui-slider-item mui-control-content" style="overflow-y:auto;">
                <div class="user_info">
                    <div class="mui-icon mui-icon-contact user-avatar"></div>
                    <div class="user_text" id="UserName">****</div>
                    <div class="user_text" id="UserMobile">****</div>
                    <div class="user_text">
                        <!--交易<span id="UserTradeCount">0</span>|-->交易次数<span id="UserUpcount">***</span>|成交率<span id="UserScore">***</span>
                    </div>
                    <div class="user_text">
                        可用资产：<span id="UserBalance">0</span>USDT 冻结资产：<span id="UserFreeze">0</span>USDT
                    </div>
                </div>
                <div class="server">
                    <ul class="mui-table-view">
                        <li class="mui-table-view-cell">
                            <a class="mui-navigate-right" href="charge.html">
                                充值
                            </a>
                        </li>
                        <li class="mui-table-view-cell">
                            <a class="mui-navigate-right" href="withdraw.html">
                                提币
                            </a>
                        </li>
                    </ul>
                    <br />
                    <ul class="mui-table-view">
                        <li class="mui-table-view-cell">
                            <a class="mui-navigate-right" href="order_list.html">
                                订单管理
                            </a>
                        </li>
                        <li class="mui-table-view-cell">
                            <a class="mui-navigate-right" href="mypreorders.html">
                                我的挂单
                            </a>
                        </li>
                    </ul>
                    <br />
                    <ul class="mui-table-view">
                        <li class="mui-table-view-cell">
                            <a class="mui-navigate-right" href="chgloginpwd.html">
                                设置登录密码
                            </a>
                        </li>
                        <li class="mui-table-view-cell">
                            <a class="mui-navigate-right" href="chgtradepwd.html">
                                设置交易密码
                            </a>
                        </li>
                        <li class="mui-table-view-cell">
                            <a class="mui-navigate-right" href="chginfo.html">
                                设置支付宝账号
                            </a>
                        </li>
                        <li class="mui-table-view-cell">
                            <a class="mui-navigate-right" href="addPay.html">
                                设置银行卡账号
                            </a>
                        </li>
                        <li class="mui-table-view-cell">
                            <a class="mui-navigate-right" href="paychannels.html">
                                支付信息
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="js/mui.min.js"></script>
<script src="js/mui.pullToRefresh.js"></script>
<script src="js/mui.pullToRefresh.material.js"></script>
<script src="js/arttmpl.js"></script>
<script src="js/jquery-2.1.4.js" type="text/javascript" charset="utf-8"></script>
<script src="js/app.js" type="text/javascript" charset="utf-8"></script>
<script type="text/template" id="tpl-buy">
    <%
    <div class="mui-table ">
        <div class="mui-table-cell mui-col-xs-10">
            <h4 class="mui-ellipsis"><%=item.showId%> | <%=name%></h4>
            <span class="mui-badge mui-badge-success" id="BuyPayChannelArea"><%=paychannel%></span>
            <div class="mui-clearfix"></div>
            <h5>交易次数**|成交率**</h5>
            <p class="mui-h6 mui-ellipsis">限额数量 <%=item.minAmount%> - <%=item.maxAmount%></p>
        </div>
        <div class="mui-table-cell mui-col-xs-2 mui-text-right">
            <span class="mui-h5"><%=item.ideaUnivalent%> CNY</span>
            <button class="list_btn" name="<%=item.id%>" onclick="toSellpage(<%=item.id%>)">出售<%=item.coinType%></button>
        </div>
    </div>
    %>
</script>
<!--<script type="text/template" id="tpl-buy">
	<%
	<div class="mui-table ">
		<div class="mui-table-cell mui-col-xs-10">
			<h4 class="mui-ellipsis"><%=item.showId%> | <%=name%></h4>
			<span class="mui-badge mui-badge-success" id="BuyPayChannelArea"><%=paychannel%></span>
			<div class="mui-clearfix"></div>
			<h5>交易次数**|成交率**</h5>
			<p class="mui-h6 mui-ellipsis">限额数量 <%=item.minAmount%> - <%=item.maxAmount%></p>
		</div>
		<div class="mui-table-cell mui-col-xs-2 mui-text-right">
			<span class="mui-h5"><%=item.ideaUnivalent%> CNY</span>
			<button class="list_btn" name="<%=item.id%>" onclick="toSellpage(<%=item.id%>)">出售<%=item.coinType%></button>
		</div>
	</div>
	%>
</script>-->
<script type="text/template" id="tpl-sell">
    <%
    <div class="mui-table ">
        <div class="mui-table-cell mui-col-xs-10">
            <h4 class="mui-ellipsis"><%=item.showId%> | <%=name%></h4> <!--<%=item%>-->
            <span class="mui-badge mui-badge-success" id="SellPayChannelArea"><%=paychannel%></span>
            <div class="mui-clearfix"></div>
            <h5>交易次数**|成交率**</h5>
            <p class="mui-h6 mui-ellipsis">限额数量 <%=item.minAmount%> - <%=item.maxAmount%></p>
        </div>
        <div class="mui-table-cell mui-col-xs-2 mui-text-right">
            <span class="mui-h5"><%=item.ideaUnivalent%> CNY</span>
            <button class="list_btn" name="<%=item.id%>" onclick="toBuypage(<%=item.id%>)">购买<%=item.coinType%></button>
        </div>
    </div>
    %>
</script>
<script type="text/javascript">
    mui.init();
    var scrollPage = {
        // 存放上拉的次数，查询数据时需要分页
        sell: 0,
        buy: 0,
        tfbuyscroll: false,
        tfsellscroll: false,
        currentPage: "#item1mobile",
    };
    document.querySelector(".mui-content").setAttribute("style","height: "+document.body.scrollHeight+"px;");
    (function($) {

        // todo 检查用户是否登录
        if(!sessionStorage.getItem("login")) {
            location.href = "login.html";
        }
        var _page_return = localStorage.getItem("PAGE_RETURN");
        if(_page_return) {
            console.log(_page_return); //1:出售列表返回  2：“我的”列表中跳转页面点击返回
            var _elements = document.querySelectorAll(".mui-tab-item");
            var _elements2 = document.querySelectorAll(".mui-slider-item");
            _elements[0].classList.remove("mui-active");
            _elements2[0].classList.remove("mui-active");
            if(_page_return == 1) {
                _elements[1].classList.add("mui-active");
                _elements2[1].classList.add("mui-active");
                document.getElementById("IndexNavTitle").innerHTML = "出售列表";
            } else if(_page_return == 2) {
                _elements[3].classList.add("mui-active");
                _elements2[3].classList.add("mui-active");
                document.getElementById("IndexNavTitle").innerHTML = "个人中心";
                getUserInfo(function(info){
                    fillMember(info)
                })

            }
            localStorage.removeItem("PAGE_RETURN");
        }
        //阻尼系数
        var deceleration = mui.os.ios ? 0.003 : 0.0009;
        $('.mui-scroll-wrapper').scroll({
            bounce: false,
            indicators: true, //是否显示滚动条
            deceleration: deceleration
        });
        $.ready(function() {
            mui('.mui-slider').slider().stopped = true; //禁止页面左右滑动
            $("#tfbuy-scroll").pullToRefresh({
                down: {
                    callback: function() {
                        console.log("刷新购买单数据")
                        var self = this;
                        setTimeout(function() {
                            getPreTrade("sell", 1, function(data) {
                                fill(data, "sell", true)
                            });
                            self.endPullDownToRefresh()
                        }, 1000);
                    }
                },
                up: {
                    callback: function() {
                        console.log("加载更多购买单数据")
                        var self = this;
                        setTimeout(function() {
                            getPreTrade("sell", scrollPage.sell + 1, function(data) {
                                fill(data, "sell")
                            });
                            self.endPullUpToRefresh();
                        }, 1000);
                    }
                }
            })
            $("#tfsell-scroll").pullToRefresh({
                down: {
                    callback: function() {
                        console.log("刷新出售单数据")
                        var self = this;
                        setTimeout(function() {
                            getPreTrade("buy", 1, function(data) {
                                fill(data, "buy", true)
                            });
                            self.endPullDownToRefresh()
                        }, 1000);
                    }
                },
                up: {
                    callback: function() {
                        console.log("加载更多出售单数据")
                        var self = this;
                        setTimeout(function() {
                            getPreTrade("buy", scrollPage.sell + 1, function(data) {
                                fill(data, "buy")
                            });
                            self.endPullUpToRefresh();
                        }, 1000);
                    }
                }
            })
            init();
        });

        mui("#item1mobile").on("tap", ".list_btn", function(event) {
            console.log(event)
            var id = event.target.name; // 取 button 中name属性，跳页面时带上
            location.href = "buy.html?id=" + id;
        });
        mui("#item2mobile").on("tap", ".list_btn", function(target) {
            console.log(event)
            var id = event.target.name; // 取 button 中name属性，跳页面时带上
            location.href = "sell.html?id=" + id;
        });
        mui(".mui-bar-tab").on("tap", ".mui-tab-item",function(event){
            var tab = this.id;
            changeTab(tab)
        })
    })(mui);

    function init() {
        // 列表
        getPreTrade("buy", 1, function(data){
            fill(data, "buy", true)
        })
        getPreTrade("sell", 1, function(data){
            fill(data, "sell", true)
        })

        // 发布挂单界面 账号
        jsAjax.getPayChannel(function(data){
            if(data.alipay) {
                $("#AlipayDiv").show();
                $("#AlipayArea").text(data.alipay.payAccount);
            }
            if(data.unionpay) {
                $("#UnionpayDiv").show();
                $("#UnionpayArea").text(data.unionpay.payAccount)
            }
        })
    }



    function toBuypage(id){
        location.href = "buy.html?id=" + id;
    }
    function toSellpage(id){
        location.href = "sell.html?id=" + id;
    }

    var USDTPrice;

    function changeTab(tab) {
        // document.getElementById(tab).scrollIntoView();
        if("Tab3" == tab){
            coinPrice("USDT", function(data){
                $("#CoinPrice").text(data.USDT)
                USDTPrice = data.USDT
            })
            $("#IndexNavTitle").text("发布挂单");
        }
        if("Tab4" == tab){
            $("#IndexNavTitle").text("个人中心");
            getUserInfo(function(info){
                fillMember(info)
            })
        }
        if("Tab2" == tab) {
            $("#IndexNavTitle").text("出售列表");
        }
        if("Tab1" == tab) {
            $("#IndexNavTitle").text("购买列表");
        }
    }
    function getUserInfo(callback) {
        var params = {
            url: "/member/detail"
        }
        jsAjax.ajax(params, function(data) {
            if(callback) {
                callback(data)
            }
        }, function(XMLHttpRequest) {
            if(XMLHttpRequest == "relogin") {
                mui.alert("登陆过期，请重新登陆")
                location.href = "index.html"
            } else {
                mui.alert(XMLHttpRequest.responseJSON.message)
            }
        });
    }

    function changePreOrderType(target, obj) {
        /*if(target.value == "sell") {
            $(".input-buy-max").hide();
            $(".input-sell-min").show();
            return;
        }
        if(target.value == "buy") {
            $(".input-sell-min").hide();
            $(".input-buy-max").show();
            return;
        }*/
    }

    function fill(data, type, reload) {
        var doc = $("#tf-" + type);
        if(reload) {
            doc.empty();
        }
        doc.append(createPreOrderFragment(data.data, type));
        if(data.data != null && data.data.length > 0) {
            scrollPage[type] = data.page
        }
    }

    var createPreOrderFragment = function(preOrder, type) {
        var fragment = document.createDocumentFragment();
        var li;
        $.each(preOrder, function(index, value) {
            li = document.createElement('li');
            // li.className = 'mui-table-view-cell ' + value.memberFlag;
            li.className = 'mui-table-view-cell ';

            if(value.preTrade.coinType == "TF"){
                value.preTrade.coinType = "TF";
            }
            var paychannel = "支付宝";
            if(value.memberFlag && value.memberFlag =="inmoney"){
                paychannel = "银行卡"
            }
            if(value.memberFlag && value.memberFlag =="platform"){
                paychannel = "银行卡、支付宝"
            }
            var str = template('tpl-' + type, {
                item: value.preTrade,
                name: value.name,
                paychannel: paychannel
            })
            li.innerHTML = str;
            fragment.appendChild(li);
        });
        return fragment;
    }

    function getPreTrade(type, page, callback) {
        console.log("获取挂单信息")
        var params = {};
        params.url = "/trade/pre/list?size=10&type=" + type + "&page=" + page + "&status=normal";
        jsAjax.ajax(params, function(data) {
            if(callback) {
                callback(data)
            }
        }, function(XMLHttpRequest) {
            if(XMLHttpRequest == "relogin") {
                mui.alert("登陆过期，请重新登陆")
                location.href = "index.html"
            } else {
                mui.alert(XMLHttpRequest.responseJSON.message)
            }
        });
    }

    function publishPretrade() {
        var _tradeType = $("input[name=tradeType]:checked").val();
        var _ideaPrice = USDTPrice;
        var _message = $("#MsgIpt").val();
        var _allAmount = $("#AmountIpt").val();
        var _maxAmount = _allAmount;
        var _minAmount = _allAmount;

        var _toRealName = $("#ToRealName").val();
        var _toPayAccount = $("#ToPayAccount").val();
        var _toBank = $("#ToBank").val();
        var _toBranchBank = $("#ToBranchBank").val();

        if(!_ideaPrice) {
            mui.alert("请输入交易价格")
            return;
        }
        if(!_allAmount || isNaN(_allAmount)) {
            mui.alert("请输入交易量")
            return;
        }

        if(!_toRealName || !_toPayAccount || !_toBank || !_toBranchBank){
            mui.alert("请输入完整收款人信息")
            return;
        }

        var data = {};
        data.tradeType = _tradeType;
        data.ideaUnivalent = _ideaPrice;
        data.minAmount = _minAmount;
        data.maxAmount = _maxAmount;
        data.message = _message;
        data.allAmount = _allAmount;
        data.coinType = "USDT";
        data.payChannelType = "unionpay";
        data.payto = {
            realName: _toRealName,
            payAccount: _toPayAccount,
            bank: _toBank,
            branchBank: _toBranchBank
        }
        var params = {
            data: data,
            url: "/trade/pre/inmoney",
            type: "post",
        };
        // todo validate data
        jsAjax.ajax(params, function(data) {
            mui.alert("发布成功");
            location.href = "index.html"
        }, function(XMLHttpRequest) {
            if(XMLHttpRequest == "relogin") {
                mui.alert("登陆过期，请重新登陆")
                location.href = "index.html"
            } else {
                mui.alert(XMLHttpRequest.responseJSON.message)
            }
        });
    }

    function coinPrice(type, callback) {
        if(type == null || type == undefined) {
            mui.alert("请选择有效币种")
            return;
        }
        var params = {};
        params.url = "/coin/market/price?coinType=" + type;
        jsAjax.ajax(params, function(data) {
            if(callback) {
                callback(data)
            }
        }, function(XMLHttpRequest) {
            if(XMLHttpRequest == "relogin") {
                mui.alert("登陆过期，请重新登陆")
                location.href = "index.html"
            } else {
                mui.alert(XMLHttpRequest.responseJSON.message)
            }
        });
    }

    var downTime = 60;

    function setTime() {
        setTimeout(function() {
            if(downTime > 0) {
                document.querySelector(".yzm_btn").disabled = "disabled"; //禁用获取验证码按钮
                document.querySelector(".yzm_btn").innerHTML = downTime + "s";
                downTime--;
                setTime();
            } else {
                document.querySelector(".yzm_btn").removeAttribute("disabled");
                document.querySelector(".yzm_btn").innerHTML = "获取验证码"
                downTime = 60;
            }
        }, 1000)
    }

    function fillMember(info) {
        $("#UserName").text(info.name);
        $("#UserMobile").text(info.mobile);
        $("#UserTradeCount").text(info.tradeCount);
        // $("#UserUpcount").text(info.upcount);
        // $("#UserScore").text(info.score);

        if(info.accountInfo){
            $("#UserBalance").text(info.accountInfo.USDT_balance);
            $("#UserFreeze").text(info.accountInfo.USDT_freeze);
        }
    }
</script>
</body>

</html>